---
# Example: Batch processing job for parameter sweep
# Use case: Buckingham Pi theorem analysis across parameter space
apiVersion: batch/v1
kind: Job
metadata:
  name: dimtensor-batch-job
  labels:
    app: dimtensor
    component: batch
spec:
  # Run 10 parallel pods, complete all 100 tasks
  parallelism: 10
  completions: 100
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400  # Clean up after 24 hours

  template:
    metadata:
      labels:
        app: dimtensor
        component: batch
    spec:
      restartPolicy: OnFailure

      # Init container to prepare data
      initContainers:
      - name: prepare-data
        image: busybox:1.36
        command: ['sh', '-c', 'mkdir -p /data/input /data/output && echo "Data prepared"']
        volumeMounts:
        - name: data
          mountPath: /data

      containers:
      - name: dimtensor
        image: dimtensor:latest  # Use base image for CPU workloads
        imagePullPolicy: IfNotPresent

        command: ['python', '-c']
        args:
        - |
          import os
          from dimtensor import DimArray, units
          from dimtensor.analysis import buckingham_pi
          import numpy as np

          # Get task index from environment
          task_id = int(os.environ.get('JOB_COMPLETION_INDEX', 0))
          print(f"Processing task {task_id}")

          # Define parameter space
          velocities = np.linspace(1, 100, 100)[task_id:task_id+1]

          # Example: analyze drag force dimensionless groups
          for v in velocities:
              velocity = DimArray([v], units.m / units.s)
              length = DimArray([1.0], units.m)
              density = DimArray([1.225], units.kg / units.m**3)
              viscosity = DimArray([1.81e-5], units.kg / (units.m * units.s))

              # Calculate Reynolds number
              Re = (density * velocity * length / viscosity).to(units.dimensionless)

              print(f"Velocity: {velocity}, Reynolds: {Re}")

              # Save results
              with open(f'/data/output/result_{task_id}.txt', 'w') as f:
                  f.write(f"{v},{Re.data[0]}\n")

        env:
        - name: JOB_COMPLETION_INDEX
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']

        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"

        volumeMounts:
        - name: data
          mountPath: /data
        - name: config
          mountPath: /config

        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false  # Need to write temp files

      volumes:
      - name: data
        emptyDir: {}  # Temporary storage for batch job
      - name: config
        configMap:
          name: dimtensor-config
          optional: true

---
# Optional: ConfigMap for physics parameters
apiVersion: v1
kind: ConfigMap
metadata:
  name: dimtensor-config
data:
  physics_params.json: |
    {
      "gravity": 9.81,
      "air_density": 1.225,
      "air_viscosity": 1.81e-5
    }
