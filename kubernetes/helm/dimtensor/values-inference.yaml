# Preset values for inference API workloads
# Usage: helm install dimtensor-api ./dimtensor -f values-inference.yaml

# Use deployment workload type
workloadType: deployment

# Use CPU-full image with all dependencies
image:
  variant: cpu-full
  pullPolicy: IfNotPresent

# 3 replicas for high availability
replicaCount: 3

# Inference API resources
resources:
  requests:
    cpu: 500m
    memory: 2Gi
  limits:
    cpu: 2000m
    memory: 8Gi
  gpu:
    enabled: false

# Enable service
service:
  enabled: true
  type: ClusterIP
  port: 80
  targetPort: http

# Enable autoscaling
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
      - type: Pods
        value: 2
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 4
        periodSeconds: 30

# Pod anti-affinity for spreading across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: dimtensor
        topologyKey: kubernetes.io/hostname

# Prometheus metrics
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

# Health probes
livenessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 30

readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10

startupProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  failureThreshold: 12

# Flask API server
container:
  port: 8080
  command: ['python', '-c']
  args:
  - |
    from flask import Flask, request, jsonify
    from dimtensor import DimArray, units
    from dimtensor.errors import DimensionError

    app = Flask(__name__)

    @app.route('/health')
    def health():
        return jsonify({"status": "healthy"}), 200

    @app.route('/ready')
    def ready():
        try:
            test = DimArray([1], units.m)
            return jsonify({"status": "ready"}), 200
        except Exception as e:
            return jsonify({"status": "not ready", "error": str(e)}), 503

    @app.route('/api/v1/validate', methods=['POST'])
    def validate_dimensions():
        try:
            data = request.json
            mass = DimArray([data['mass']], units.kg)
            acceleration = DimArray([data['acceleration']], units.m / units.s**2)
            force = mass * acceleration
            return jsonify({
                "valid": True,
                "force": {
                    "value": float(force.data[0]),
                    "unit": str(force.unit),
                    "dimension": str(force.dimension)
                }
            }), 200
        except DimensionError as e:
            return jsonify({"valid": False, "error": str(e)}), 400
        except Exception as e:
            return jsonify({"error": str(e)}), 500

    @app.route('/api/v1/convert', methods=['POST'])
    def convert_units():
        try:
            data = request.json
            value = data['value']
            from_unit = getattr(units, data['from_unit'])
            to_unit = getattr(units, data['to_unit'])
            arr = DimArray([value], from_unit)
            converted = arr.to(to_unit)
            return jsonify({
                "original": {"value": value, "unit": data['from_unit']},
                "converted": {"value": float(converted.data[0]), "unit": data['to_unit']}
            }), 200
        except Exception as e:
            return jsonify({"error": str(e)}), 500

    @app.route('/metrics')
    def metrics():
        return "# HELP dimtensor_requests_total Total requests\n# TYPE dimtensor_requests_total counter\ndimtensor_requests_total 0\n", 200

    if __name__ == '__main__':
        app.run(host='0.0.0.0', port=8080)
  env:
  - name: FLASK_ENV
    value: "production"
  - name: PYTHONUNBUFFERED
    value: "1"

# Optional: Enable Ingress
ingress:
  enabled: false
  # Uncomment to enable:
  # enabled: true
  # className: nginx
  # annotations:
  #   cert-manager.io/cluster-issuer: letsencrypt-prod
  # hosts:
  #   - host: dimtensor.example.com
  #     paths:
  #       - path: /
  #         pathType: Prefix
  # tls:
  #   - secretName: dimtensor-tls
  #     hosts:
  #       - dimtensor.example.com
