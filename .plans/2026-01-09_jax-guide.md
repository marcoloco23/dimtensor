# Plan: JAX Integration Guide

**Date**: 2026-01-09
**Status**: PLANNING
**Author**: planner agent

---

## Goal

Create comprehensive user documentation for the JAX integration (docs/guide/jax.md) that teaches users how to use dimtensor with JAX transformations while preserving unit safety.

---

## Background

dimtensor provides JAX-compatible DimArray that works seamlessly with JAX's transformations (jit, vmap, grad). The current codebase has full JAX integration in src/dimtensor/jax/dimarray.py with pytree registration, but lacks user-facing documentation. Users need to understand:

1. How to use DimArray with JAX arrays
2. How pytree registration enables JAX transformations
3. How to use jax.jit for performance
4. How to use jax.vmap for vectorization
5. How to use jax.grad for differentiation
6. Performance considerations and best practices

This guide will help users leverage JAX's powerful transformations while maintaining dimensional safety.

---

## Approach

### Option A: Single comprehensive guide
- Description: One document covering all JAX features
- Pros:
  - All JAX information in one place
  - Easier to maintain consistency
  - Natural progression from basics to advanced
- Cons:
  - Could be long for a single page
  - Might overwhelm beginners

### Option B: Split into multiple documents
- Description: Separate docs for jit, vmap, grad
- Pros:
  - Each page is focused
  - Easier to find specific features
- Cons:
  - More navigation required
  - Potential content duplication
  - More files to maintain

### Decision: Option A - Single comprehensive guide

Reasoning: JAX features are closely related and often used together. A single guide allows showing realistic examples that combine jit+vmap, or jit+grad. The guide can have clear sections with anchors for navigation. Based on the existing test coverage, the content is manageable in one document.

---

## Implementation Steps

1. [ ] Create docs/guide/jax.md with initial structure
2. [ ] Write introduction section explaining JAX integration benefits
3. [ ] Write "Getting Started" section with basic DimArray + JAX examples
4. [ ] Write "Pytree Registration" section explaining how it works
5. [ ] Write "JIT Compilation" section with jax.jit examples
6. [ ] Write "Vectorization with vmap" section with batching examples
7. [ ] Write "Automatic Differentiation" section with jax.grad examples
8. [ ] Write "Combining Transformations" section (jit+vmap, jit+grad)
9. [ ] Write "Performance Considerations" section
10. [ ] Write "Common Patterns" section with real-world examples
11. [ ] Add "Limitations and Gotchas" section
12. [ ] Review and polish examples for clarity

---

## Files to Modify

| File | Change |
|------|--------|
| docs/guide/jax.md | Create new guide document |
| docs/index.md | Add link to JAX guide (if not already present) |

---

## Testing Strategy

How will we verify this works?

- [ ] Run all code examples in the guide to ensure they work
- [ ] Verify all imports are correct
- [ ] Check that examples match the test patterns in tests/test_jax.py
- [ ] Ensure dimensional correctness is clear in all examples
- [ ] Verify code snippets follow existing guide style

---

## Risks / Edge Cases

- **Risk**: Examples might not reflect latest JAX API changes
  - **Mitigation**: Use JAX patterns that are stable and well-documented; test all examples

- **Risk**: Users might expect features not yet implemented (e.g., grad with respect to DimArray)
  - **Mitigation**: Clearly document current capabilities and limitations

- **Risk**: Performance advice might become outdated
  - **Mitigation**: Keep performance section high-level, focus on general principles

- **Edge case**: Complex nested pytree structures
  - **Handling**: Start with simple examples, mention nesting is supported

- **Edge case**: Dimensional correctness with grad
  - **Handling**: Explain that gradients have dimensions (derivative units)

---

## Definition of Done

- [ ] All implementation steps complete
- [ ] All code examples tested and working
- [ ] Documentation follows existing guide style and formatting
- [ ] Examples demonstrate key features from tests/test_jax.py
- [ ] CONTINUITY.md updated with task completion

---

## Content Outline

### 1. Introduction
- What is JAX?
- Why use dimtensor with JAX?
- Installation requirements

### 2. Getting Started
- Basic imports
- Creating JAX DimArray
- Simple arithmetic operations
- Unit preservation

### 3. Understanding Pytrees
- What is a pytree?
- How DimArray is registered
- Why this matters for transformations
- Flatten/unflatten example

### 4. JIT Compilation (jax.jit)
- Basic jit example
- Performance benefits
- Unit preservation through jit
- Physics function example (kinetic energy)
- Common patterns

### 5. Vectorization (jax.vmap)
- What is vmap?
- Batching operations
- Batch dimension handling
- Example: Vectorized force calculations
- vmap with multiple arguments

### 6. Automatic Differentiation (jax.grad)
- Using grad with DimArray
- Gradient dimensions
- Example: Finding optimal trajectory
- value_and_grad usage
- Limitations with unit tracking

### 7. Combining Transformations
- jit + vmap: Fast batched operations
- jit + grad: Fast gradients
- vmap + grad: Batched gradients (Jacobians)
- Real example: Neural network with units

### 8. Performance Considerations
- When to use jit vs regular Python
- Memory layout and efficiency
- XLA optimization tips
- Avoiding common pitfalls

### 9. Common Patterns
- Physics simulations
- Optimization with units
- Batched unit conversions
- Error bounds propagation

### 10. Limitations and Troubleshooting
- What JAX features work vs. don't work
- Common errors and solutions
- When to strip units (magnitude())
- Debugging jit compilation issues

---

## Key Examples to Include

Based on tests/test_jax.py, ensure these examples are covered:

1. **Basic Creation**: From JAX array, list, scalar
2. **JIT Example**: Kinetic energy function
3. **JIT Chaining**: Multiple operations (x + y*t)
4. **vmap Basic**: Square function over batch
5. **vmap Binary**: Multiply two batched arrays
6. **grad Example**: Gradient of scalar function
7. **Conversions**: to() method with units
8. **Reductions**: sum, mean, var with axis
9. **Linear Algebra**: dot, matmul with dimension handling
10. **Real Physics**: Projectile motion with jit+vmap

---

## Notes / Log

**[2026-01-09]** - Plan created after reviewing:
- Template structure
- JAX integration code (src/dimtensor/jax/dimarray.py)
- Test coverage (tests/test_jax.py) - excellent coverage of all features
- Existing guide style (docs/guide/operations.md, docs/guide/examples.md)
- JAX pytree registration implementation

The pytree registration happens automatically on import, which is elegant and should be highlighted in the guide.

---
